{% extends "base.html" %}

{% block title %}{{ _('stats_title') }}{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<section class="translation-shell stats-section">
    <div class="hero-text">
        <h2>{{ _('stats_header') }}</h2>
        <p>{{ _('stats_subheader') }}</p>
    </div>

    <div class="global-stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ total_votes }}</div>
            <div class="stat-label">{{ _('total_votes') }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ global_stats.total_generations }}</div>
            <div class="stat-label">{{ _('total_translations') }}</div>
        </div>
        <div class="stat-card">
             <div class="stat-value">${{ "%.2f"|format(global_stats.total_cost) }}</div>
            <div class="stat-label">{{ _('total_cost') }}</div>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="modelPerformanceChart"></canvas>
    </div>

    <div class="stats-details">
        <h3>{{ _('stats_table_header') }}</h3>
        <table>
            <thead>
                <tr>
                    <th data-sort="number">{{ _('rank') }}</th>
                    <th data-sort="string">{{ _('model_name') }}</th>
                    <th>{{ _('rating_distribution', total_votes=total_votes) }}</th>
                    <th data-sort="number">{{ _('avg_score') }}</th>
                    <th data-sort="number">{{ _('elo_rating') }}</th>
                    <th data-sort="number">{{ _('combined_score') }}
                    <div style="font-size: 0.75em; color: #6b7280; margin-top: 2px;">Avg + ELO</div></th>
                    <th data-sort="number">{{ _('projected_cost_100k') }}</th>
                    <th data-sort="number">{{ _('bang_for_buck_score') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for model in model_scores %}
                <tr class="{% if not model.is_active %}deprecated-model{% endif %}">
                    <td><span class="rank-badge">{{ loop.index }}</span></td>
                    <td class="latin-content">
                        <strong>{{ model.base_model }}</strong>
                        {% if model.preset_name %}
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 2px;">{{ model.preset_name }}</div>
                        {% endif %}
                        {% if not model.is_active %}<span class="deprecated-tag">({{ _('inactive', default='Inactive') }})</span>{% endif %}
                    </td>
                    <td style="text-align: left;">
                        <div class="rating-dist-bar" title="Excellent: {{model.excellent_count}}, Good: {{model.good_count}}, Okay: {{model.okay_count}}, Rejected: {{model.rejected_count}}">
                            {% if model.votes_cast > 0 %}
                                {% if model.excellent_count > 0 %}
                                <div class="bar excellent" style="width: {{ (model.excellent_count / model.votes_cast) * 100 }}%"><span>{{ model.excellent_count }}</span></div>
                                {% endif %}
                                {% if model.good_count > 0 %}
                                <div class="bar good" style="width: {{ (model.good_count / model.votes_cast) * 100 }}%"><span>{{ model.good_count }}</span></div>
                                {% endif %}
                                {% if model.okay_count > 0 %}
                                <div class="bar okay" style="width: {{ (model.okay_count / model.votes_cast) * 100 }}%"><span>{{ model.okay_count }}</span></div>
                                {% endif %}
                                {% if model.rejected_count > 0 %}
                                <div class="bar rejected" style="width: {{ (model.rejected_count / model.votes_cast) * 100 }}%"><span>{{ model.rejected_count }}</span></div>
                                {% endif %}
                            {% else %}
                            <div class="bar no-votes" style="width: 100%">{{ _('no_votes_yet') }}</div>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% set score = model.average_score %}
                        {% if score > 1.5 %}
                            {% set score_class = 'high-score' %}
                        {% elif score > 0 %}
                            {% set score_class = 'medium-score' %}
                        {% else %}
                            {% set score_class = 'low-score' %}
                        {% endif %}
                        <span class="score-badge {{ score_class }}">{{ "%.2f"|format(score) }}</span>
                    </td>
                    <td data-sort-value="{{ model.elo_rating }}">
                        <div class="elo-badge" style="font-weight: bold; color: var(--primary);">
                            {{ "%.0f"|format(model.elo_rating) }}
                        </div>
                        <div class="win-rate" style="font-size: 0.8em; color: var(--text-secondary);">
                            {{ "%.1f"|format(model.elo_win_rate) }}% WR
                        </div>
                    </td>
                    <td>
                         <span class="score-badge" style="background-color: #f3f4f6; color: #1f2937; border: 1px solid #d1d5db;">{{ "%.2f"|format(model.combined_score) }}</span>
                    </td>
                    <td>${{ "%.2f"|format(model.projected_cost_100k) }}</td>
                    <td data-sort-value="{{ model.bang_for_buck }}">
                        <div class="bang-for-buck-bar-container" title="{{ '%.1f'|format(model.bang_for_buck) }}">
                            <div class="bang-for-buck-bar" style="width: {{ (model.bang_for_buck * 10) }}%; max-width: 100%;"></div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="stats-details" style="margin-top: 2rem;">
        <h3>{{ _('cost_breakdown_header') }}</h3>
        <table>
            <thead>
                <tr>
                    <th>{{ _('model_name') }}</th>
                    <th>{{ _('total_cost') }}</th>
                    <th>{{ _('total_translations') }}</th>
                    <th>{{ _('projected_cost_100k') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cost_breakdown %}
                <tr>
                    <td><strong>{{ item.base_model }}</strong></td>
                    <td>${{ "%.2f"|format(item.total_cost) }}</td>
                    <td>{{ item.total_generations }}</td>
                    <td>${{ "%.2f"|format(item.projected_cost_100k) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    function sortTable(table, colIndex, type) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.rows);
        const isAscending = table.getAttribute('data-sort-order') === 'asc';
        const direction = isAscending ? 1 : -1;

        rows.sort((a, b) => {
            const aCellEl = a.cells[colIndex];
            const bCellEl = b.cells[colIndex];
            
            let aVal, bVal;

            // Check for explicit sort value first
            if (aCellEl.hasAttribute('data-sort-value')) {
                const aSortVal = aCellEl.getAttribute('data-sort-value');
                const bSortVal = bCellEl.getAttribute('data-sort-value');
                
                if (type === 'number') {
                    aVal = parseFloat(aSortVal) || 0;
                    bVal = parseFloat(bSortVal) || 0;
                } else {
                    aVal = aSortVal.toLowerCase();
                    bVal = bSortVal.toLowerCase();
                }
            } else {
                const aText = aCellEl.innerText.trim();
                const bText = bCellEl.innerText.trim();

                if (type === 'number') {
                    // Remove currency symbols, commas, etc.
                    aVal = parseFloat(aText.replace(/[^0-9.-]+/g, '')) || 0;
                    bVal = parseFloat(bText.replace(/[^0-9.-]+/g, '')) || 0;
                } else {
                    aVal = aText.toLowerCase();
                    bVal = bText.toLowerCase();
                }
            }

            if (aVal === bVal) return 0;
            return (aVal > bVal ? 1 : -1) * direction;
        });

        rows.forEach(row => tbody.appendChild(row));
        table.setAttribute('data-sort-order', isAscending ? 'desc' : 'asc');
    }

    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('modelPerformanceChart').getContext('2d');
        
        const labels = {{ model_scores|map(attribute='display_name')|list|tojson }};
        const scores = {{ model_scores|map(attribute='average_score')|list|tojson }};
        const elos = {{ model_scores|map(attribute='elo_rating')|list|tojson }};
        
        // Normalize ELO to be comparable to 3-point scale for visualization (rough mapping)
        // 1300 -> 0, 1700 -> 3
        const normalizedElos = elos.map(e => Math.max(0, (e - 1300) / (1700 - 1300) * 3));

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '{{ _("average_score") }}',
                        data: scores,
                        backgroundColor: 'rgba(37, 99, 235, 0.7)',
                        borderColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: '{{ _("elo_rating") }} (Scaled)',
                        data: normalizedElos,
                        type: 'line',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        yAxisID: 'y'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 3.5,
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.dataset.type === 'line') {
                                    // Show actual ELO in tooltip, not scaled
                                    return 'ELO Rating: ' + elos[context.dataIndex].toFixed(0);
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });

        // Add sorting event listeners
        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const table = th.closest('table');
                const colIndex = th.cellIndex;
                const type = th.getAttribute('data-sort');
                sortTable(table, colIndex, type);
            });
            th.style.cursor = 'pointer';
            th.style.userSelect = 'none';
        });
    });
</script>
{% endblock %}